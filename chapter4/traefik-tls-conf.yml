# traefik-tls-conf.yml
http:
  routers:
    dashboard:
      entryPoints:
        - https
      rule: "Host(`www.liwenqiang.site`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: api@internal
      tls: 
        domains:
          - main: "www.liwenqiang.site"
      middlewares:
        - auth

tcp :
  routers :
    mosquitto-router :
      entryPoints :
      - mosquitto
      rule: "HostSNI(`www.liwenqiang.site`) || HostSNI(`127.0.0.1`)"
      service : mosquitto-tcp-service
      #This block will enable TLS for this route
      tls: 
        # the passthrough option can be specified to set 
        # whether the requests should be forwarded "as is", 
        # keeping all data encrypted
        passthrough: true 
  services:
    mosquitto-tcp-service: 
      loadBalancer:
        servers:
        - address: "127.0.0.1:8883"
#We also need to provide the TLS certificates
tls:
  stores:
      default:
        defaultCertificate:
          certFile: /etc/mosquitto/certs/server.crt
          keyFile: /etc/mosquitto/certs/server.key
  # certificates:
  #   - certFile: /etc/mosquitto/certs/server.crt
  #     keyFile: /etc/mosquitto/certs/server.key

middlewares:
  auth:
   basicAuth:
    users:
      - "admin:$apr1$JsindKAS$zCWAvabJOgQvI.Dd3zjtE."